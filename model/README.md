ABM-SEIR Simulation with Proximity Contact Data
==============

This folder contains an agent-based susceptible-exposed-infectious-removed (ABM-SEIR) model
relays individual-level proximate contacts for simulating disease spread within a community.
This model simulates, for each individual,their health status (susceptible, exposed, infectious,
and removed) and their intentaneous proximate contacts. During the simulation, infections may happen
only if an individual is infectious and having proximate contact with a suceptible.

This model takes following inputs:

  1. Baseline Bluetooth proximity contact data.
  2. Downsampling method (`SNAPSHOT` or `UPPERBOUND`) and observation interval in minutes.
  3. Disease parameters: R0, range of incubation period, and range of infectious period.

and generate following outputs:

  1. Event records of infection attempts.
  2. For each individual, the realization of their incubation period and infectious period.

 is easily configurable (without the need to recompile)



## Model Folder Structure


```
abm-seir/
├── data/
│   └── example.csv  // Baseline Bluetooth proximity contact data
│
├── exptConfig.yml  // Experiment configuration file
│
├── iEpi_SEIR_uniform // Model entrypoint, execute this bash script to run model
│
└── ... // Other model files generated by AnyLogic model export.
```


## Format of Bluetooth Proximity Contact Data

1. Contact data are CSV files with following columns in order:

  - "TimeStamp"
  - "CreatorIdentifier"
  - "DutyCycleID"
  - "MAC"
  - "RSSI"
  - "TimeSlot"


2. Column headers are required in CSV file.


3. "TimeStamp" is string formatted (local) datetime with format

  `yyyy-mm-dd HH:MM:SS`

   for example:

  `2011-04-02 00:01:00`

4. Contact data should be sorted by "TimeStamp"

5. "DutyCycleID" is an integer, which is a project of "TimeStamp" on to 5-minute bins.
   for example, if we choose `2011-04-02 00:00:00` as reference time, then:

   `2011-04-02 00:01:00` will have "DutyCycleID" `0`
   `2011-04-02 00:06:00` will have "DutyCycleID" `1`
   `2011-04-03 00:06:00` will have "DutyCycleID" `289`

6. both "creatoridentifier" and "mac" are positive integers indicating participant id.
   and "creatoridentifier" is the id of participants whose phone discovered another
   participants whose id is "mac" during effective study period.

7. "timeslot" is just zero based "dutycycleid", in the contact data file. because
   "dutycycleid" can be a signed integer depends on the referenced datetime of
   a study (which is not controllable historically). for example:

   if after filtering out unqualified participants or experiment dates, we have

   ```
   <other columns> ,"dutycycleid"
   ...             ,100
   ...             ,103
   ..              ,105
   ```
   then the "timeslot" will be

   ```
   <other columns> ,"dutycycleid","timeslot"
   ...             ,100,0
   ...             ,103,3
   ..              ,105,5
   ```



## format of experiment configuration file

1. experiment configuration file must be named `exptconfig.yml`.

2. experiment configuration file must be a valid yaml file

3. the first line must be (this is the format if one wants yaml file to config
   java object of class `exptconfig`)

   ```
   --- !!exptconfig
   ```

4. it has following fields:

 |                Config Fields | Data Type       | Ommitable? | Example Value                             |
 |                   :--------: | :--------:      |  :-------: | :-----:                                   |
 |               `datafilepath` | `string`        |   required | `data/example.csv`                        |
 |     `experimentperiodindays` | `integer`       |   required | `28`                                      |
 |             `populationsize` | `integer`       |   required | `39`                                      |
 |   `dutycyclelengthinminutes` | `double`        |   required | `5.0`                                     |
 |              `rssithreshold` | `integer`       |   required | `-80`                                     |
 |  `contagiouseventrateperday` | `double`        |   required | `288.0`                                   |
 |                `diseasename` | `string`        |   optional | `basic_flu`                               |
 |                  `diseaser0` | `double`        |   required | `3.0`                                     |
 | `incubationperiodindays_min` | `double`        |   required | `1.0`                                     |
 | `incubationperiodindays_max` | `double`        |   required | `4.0`                                     |
 | `infectiousperiodindays_min` | `double`        |   required | `3.0`                                     |
 | `infectiousperiodindays_max` | `double`        |   required | `5.0`                                     |
 |    `samplingperiodinminutes` | `list[integer]` |   required | `[5, 10, 30, 60, 90, 180, 360]`           |
 |             `samplingmethod` | `string`        |   required | `upperbound`                              |
 |                       `seed` | `list[integer]` |   required | `[25214903916, 25214903919, 25214903918]` |

where fields `samplingperiodinminutes` and `seed` are arrays, so be careful, even if
you just want to specify one value, like `5` for `samplingperiodinminutes`, the bracket
is not ommitable. so `samplingperiodinminutes: [5]`.

for `samplingmethod`, currently supported sampling methods are `upperbound` and `snapshot`.

Note that the naming of config fields `incubationperiodindays_min`, `incubationperiodindays_max` is rather
inaccurate, these fields are intended to be filled with latent period if the estimated latent period of the disease/pathogen
of interest is available. Because in our simulation, the realized `indubationperiodindays` for an individual
specifies the delay of the individual's health status transit from exposed to infectious.


## How to Run the Model

after configuration, run script `iepi_seir_uniform`.

note that you will need java runtime environment (jre) supporting java 9.

jres are backward compatible, so jre with version later than 9 should all work.


## Model Outputs

model outputs will resides within the `output/` directory under the model root folder.

```
abm-seir/
├── output/
│   ├── ... // event records of infection attempts.
│   ├── ... // for each individual, the realization of their incubation period and infectious period.
│   └── ... // more output files like above
│
├── jonathansimparser-{timestamp}.log  // log file
│
└── ... // other model files.
```

### Event records of infection attempts has

1. filename template: `iepiseir_ifi_init{initialinfectionnodeid}seed{seednumber}samp{observationinterval}_{timestamp}.csv`

2. it has following fields:

  - `timestampinminutes`: the timestamp of the event in simulation clock in minutes, starting from `0.0`.
  - `rpt_nodeidx`: the recipent agent (indiviual) of the infection attempt
  - `ifi_nodeidx`: the sender (an infectious that is in proximate contact with recipent) of the infection attempt
  - `infectionresult`: to reduce output file size, we use integer encoded infection results, such that

 | Infection Result | Meaning                                                              |
 |       :--------: | :--------:                                                            |
 |               -1 | initial infection                                                     |
 |                0 | infection attempt failed and the recipient is susceptible             |
 |                1 | infection attempt succeed, the recipent is now infected by infectious |
 |                2 | infection attempt failed, the recipient is already exposed            |
 |                3 | infection attempt failed, the recipient is infectious                 |
 |                4 | infection attempt failed, the recipient is removed                    |




### For each individual, the realization of their incubation period and infectious period has

1. filename template: `iEpiSEIR_DUR_init{initialInfectionNodeId}seed{seedNumber}samp{observationInterval}_{timestamp}.csv`

2. it has following fields:

  - `nodeIdx`: the index of the node
  - `latentPeriodInDays`: realized latent period (or incubation period if latent period is not available) for the individual
  - `infectiousPeriodInDays`: realized infectious period for the individual

